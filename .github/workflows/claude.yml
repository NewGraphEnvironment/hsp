# Claude Code — reusable workflow template
# Copy to .github/workflows/claude.yml in any repo
#
# Required secret: ANTHROPIC_API_KEY (from console.anthropic.com)
# Note: Uses Anthropic API directly, not OpenRouter
#
# Two jobs:
#   1. Auto-review on PR open/update (Haiku — fast, cheap)
#   2. Interactive @claude mentions in issues/PRs (Sonnet — capable)
#
# The action reads CLAUDE.md automatically, so repo-specific
# conventions are followed without extra config.
#
# Usage in issues/PRs:
#   @claude review this PR
#   @claude /review (uses built-in review skill)
#   @claude fix the lint errors and open a PR
#   @claude what does this function do?

name: Claude Code
on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Automatic review on every PR — uses Haiku for speed and cost
  # Only triggers for repo owner to avoid unauthorized API spend
  review:
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'NewGraphEnvironment'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            Review this pull request. Focus on:
            - Correctness and potential bugs
            - Style consistency with existing code
            - Security implications
            - Missing tests for new functionality

            Be concise. Only flag issues worth fixing.
            Use inline comments for specific code issues.
            Use a top-level PR comment for summary.

          claude_args: |
            --model claude-haiku-4-5-20251001
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
            --max-turns 10

  # Interactive @claude mentions — uses Sonnet for deeper reasoning
  # Works in issues AND PRs. Can create branches, open PRs, fix code.
  # Supports slash commands: @claude /review, @claude /help
  interactive:
    if: |
      github.event_name != 'pull_request' &&
      contains(github.event.comment.body, '@claude') &&
      github.actor == 'NewGraphEnvironment'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 20
